---
title: "BlogDataWrangling"
output: html_document
date: "2023-04-18"
---

## Importing libraries ##
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(mdsr)
library(tidyverse)
library(lubridate)
library(scales)
library(knitr)
library(dplyr)
library(stringr)
library(ggplot2)
library(data.table)
library(timetk)
library(plyr)
library(zoo)
library(clock)
```

## R Markdown ##

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
row <- raw_data[838,]
```

## Uploading data file ##
```{r initial wrangling}
file <- "data/runreport.xlsx"
raw_data <- readxl::read_xlsx(file)
```

## Data wrangling of main dataset ##
```{r initial wrangling}
data <- raw_data %>%
  janitor::clean_names() %>% 
  select(-c(x6, x7, x8, was_this_call_an_especially_stressful_or_emotionally_difficult_experience_for_any_members_of_the_responding_team)) %>% 
  dplyr::rename(complaint = "chief_complaint") %>%
  mutate(abbr = substr(complaint,0,4)) %>%
  mutate(abbr = tolower(abbr)) %>%
  mutate(complaint = tolower(complaint)) %>% 
  arrange(abbr) %>%
  mutate(complaint = case_when(
    abbr == "acut" ~ "acute abdominal pain",
    abbr == "alle" | abbr == "hive" | abbr == "mild" | abbr == "mino" | abbr == "rash" | abbr == "skin"
    ~ "allergic reaction",
    abbr == "anap" ~ "anaphylaxsis",
    abbr == "beha" | abbr == "ment" | abbr == "pani" | abbr == "ams/" | abbr == "anxi" | abbr == "psyc" ~ "mental health",
    abbr == "burn" ~ "burn",
    abbr == "card" ~ "cardiovascular emergency",
    abbr == "ches" | abbr == "non" | abbr == "angi" ~ "chest pain",
    abbr == "dizz" ~ "dizziness",
    abbr == "envi" | abbr == "chem" | abbr == "bee " | abbr == "bug " | abbr == "heat" | abbr == "hot " | abbr == "cold" | abbr == "hydr" | abbr == "inse" | abbr == "wasp" | abbr == "tick" ~ "environmental injuries",
    abbr == "etoh" | abbr == "eval" ~ "alcohol and/or drugs",
    abbr == "eye " | abbr == "faci" | abbr == "blur" | abbr == "cott" | abbr == "ear " | abbr == "fore" | abbr == "irri" | abbr == "ocul" | abbr == "pain" ~ "eye/ear injuries",
    abbr == "fall" ~ "fall",
    abbr == "flu-" ~ "flu-like symptoms",
    abbr == "gast" | abbr == "naus" | abbr == "stom" | abbr == "emes" | abbr == "food"
    ~ "gastrointestinal",
    abbr == "head" | abbr == "migr" ~ "headache/head injury", 
    abbr == "hemo" | abbr == "lace" | abbr == "fing" ~ "laceration/hemorrhage",
    abbr == "hypo" | abbr == "diab" ~ "hypoglycemia",
    abbr == "moto" ~ "motor vehicle accident",
    abbr == "musc" | abbr == "arm " | abbr == "icep" | abbr == "leg " ~ "musculoskeletal injury",
    abbr == "over" | abbr == "took" ~ "non-alcoholic overdose",
    abbr == "resp" | abbr == "tons" | abbr == "asth" ~ "respiratory distress",
    abbr == "seiz" ~ "seizure",
    abbr == "soft" | abbr == "abra" | abbr == "spli" | abbr == "hema" | abbr == "scap" ~ "soft tissue injury",
    abbr == "stro" | abbr == "sync" ~ "stroke/syncope",
    TRUE ~ "other"
  )) %>%
  mutate(location = tolower(location)) %>%
  mutate(loc_abbr = substr(location,0,4)) %>%
  mutate(location = case_when(
    loc_abbr == "book" ~ "booknplow farm",
    loc_abbr == "chap" | loc_abbr == "hump" ~ "chapman/humphires/lincoln/rice",
    loc_abbr == "char" ~ "charles drew/cohan/lipton/garman/porter",
    loc_abbr == "conv" | loc_abbr == "noah" | loc_abbr == "morr" 
    ~ "noah webster circle",
    loc_abbr == "fres" | loc_abbr == "firs" ~ "first-year quad",
    loc_abbr == "gree" ~ "greenway dorms",
    loc_abbr == "gym/" ~ "gym/athletic fields",
    loc_abbr == "keef" ~ "keefe/beneski/mead",
    loc_abbr == "king" ~ "king/wieland",
    loc_abbr == "mars" ~ "marsh/plimpton/tyler",
    loc_abbr == "mayo" ~ "mayo-smith/seelye/hitchcock",
    loc_abbr == "merr" ~ "merrill/mcguire/seeley mudd",
    loc_abbr == "nepo" | loc_abbr == "newp" ~ "newport/seligman",
    loc_abbr == "powe" ~ "powerhouse",
    loc_abbr == "scie" ~ "science center",
    loc_abbr == "tapl" ~ "taplin/jenkins",
    loc_abbr == "vale" ~ "valentine quad"
  )) %>% 
  mutate(result = case_when(
    result == "Refusal" | result == "result" | result == "This didn't have to be a call" ~ "ACEMS care only",
    TRUE ~ "Higher level of care"
  )) %>% 
  mutate(
    ifEtOH = ifelse(complaint == "alcohol and/or drugs", 1, 0),
    time_of_call = substr(time_of_call,11,19),
    date_time = paste(date_of_call, time_of_call, sep = " ")) %>% 
  mutate(date_time = as.POSIXct(date_time)) %>% 
  filter(date_time > as.POSIXct("2000-07-01 01:00:00")) %>% 
  mutate(month = format(date_of_call, "%Y-%m")) %>%
  mutate(year = format(date_of_call, "%Y"))
```

## Visual 1: Leaflet ##

# Data wrangling
```{r}
visual1data <- data %>%
  pivot_longer(location, names_to = "name", values_to = "location") %>% 
  group_by(location) %>%
  dplyr::summarize(
    N = n())
```

# Visual
```{r}

```

## Visual 2: Types of emergencies vs level of care needed ##

# Data wrangling
```{r initial wrangling}
visual2data <- data %>% 
  group_by(complaint) %>% 
  dplyr::summarize(
    N = n(),
    num_ACEMS = sum(result == "ACEMS care only"),
    num_higher = sum(result == "Higher level of care")
  ) %>% 
  mutate(
    per_ACEMS = round(((num_ACEMS) / N) * 100, digits = 2),
    per_higher = round(((num_higher) / N) * 100, digits = 2)
  )
```

## Visual 3: number of calls over time ##

# Data wrangling
```{r}
visual3data <- data %>% 
  group_by(month) %>% 
  dplyr::summarize(
    N = n(),
    Nalc = sum(ifEtOH == 1)
  )
```

# Visual
```{r}

```


## Visual 4: calls at specific times of day and days of the week ##

# Data wrangling
```{r initial wrangling}
visual4temp <- data %>% 
  mutate(
    day_of_week = weekdays(as.Date(date_of_call)),
    temp_date = as.POSIXct(paste0("2000-02-02", time_of_call)),
    time_of_day = case_when(
      temp_date >= as.POSIXct("2000-02-02 00:00:00") & temp_date < as.POSIXct("2000-02-02 04:00:00") ~ "Late night",
      temp_date >= as.POSIXct("2000-02-02 04:00:00") & temp_date < as.POSIXct("2000-02-02 08:00:00") ~ "Early morning",
      temp_date >= as.POSIXct("2000-02-02 08:00:00") & temp_date < 
as.POSIXct("2000-02-02 12:00:00") ~ "Morning",
      temp_date >= as.POSIXct("2000-02-02 12:00:00") & temp_date <
as.POSIXct("2000-02-02 16:00:00") ~ "Afternoon",
      temp_date >= as.POSIXct("2000-02-02 16:00:00") & temp_date <
as.POSIXct("2000-02-02 20:00:00") ~ "Evening",
      temp_date >= as.POSIXct("2000-02-02 20:00:00") & temp_date <
as.POSIXct("2000-02-02 24:00:00") ~ "Late evening"
    )
  )

visual4combine <- visual4temp %>% 
  group_by(day_of_week, time_of_day) %>% 
  dplyr::summarize(
    N = n()
  )

visual4day <- visual4temp %>% 
  group_by(time_of_day) %>% 
  dplyr::summarize(
    N = n()
  )

visual4week <- visual4temp %>% 
  group_by(day_of_week) %>% 
  dplyr::summarize(
    N = n()
  )
```


```{r initial wrangling}
data_month_summary <- data %>%
  group_by(month)
```


```{r initial wrangling}
data_scatter <- data %>%
  group_by(month) %>%
  dplyr::summarize(
    total_cases = n(),
    ETOH_cases = sum(ifEtOH)
  ) %>%
  ungroup() %>%
  mutate(month = paste(month, "-01", sep = ""))%>%
  mutate(
    month = as.POSIXct(month),
    month_label = date_month_factor(month, labels = "en", abbreviate = TRUE)) %>%
  filter(total_cases > 10)
    #month(month))
         
data_scatter
```


```{r initial wrangling}
data_bar <- data_scatter %>%
  pivot_longer(c(total_cases, ETOH_cases), names_to = "cases", values_to = "value")

data_bar
```


```{r initial wrangling}
ggplot(data_scatter, aes(x = month, y = total_cases)) + geom_point() + 
  scale_y_continuous()

ggplot(data_bar, aes(x = month, y = value, fill = cases)) +
  geom_col(stat="identity") + 
  scale_y_continuous()
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
