---
title: "BlogDataWrangling"
output: html_document
date: "2023-04-18"
---

## Importing libraries ##
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(mdsr)
library(tidyverse)
library(lubridate)
library(scales)
library(knitr)
library(dplyr)
library(stringr)
library(ggplot2)
library(data.table)
library(timetk)
library(plyr)
library(zoo)
library(clock)
library(sf)
library(leaflet)
library(colorspace)
library(scales)
```

## R Markdown ##

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

## Uploading data file ##
```{r initial wrangling}
file <- "data/runreport.xlsx"
map_file <- "data/BlogMapData.kml"
raw_data <- readxl::read_xlsx(file)
raw_map_data <- st_read(map_file) %>% 
  filter(Name != "booknplow farm")
```

## Data wrangling of main dataset ##
```{r initial wrangling}
data <- raw_data %>%
  janitor::clean_names() %>% 
  select(-c(x6, x7, x8, was_this_call_an_especially_stressful_or_emotionally_difficult_experience_for_any_members_of_the_responding_team)) %>% 
  dplyr::rename(complaint = "chief_complaint") %>%
  mutate(abbr = substr(complaint,0,4)) %>%
  mutate(abbr = tolower(abbr)) %>%
  mutate(complaint = tolower(complaint)) %>% 
  arrange(abbr) %>%
  mutate(complaint = case_when(
    abbr == "acut" ~ "acute abdominal pain",
    abbr == "alle" | abbr == "hive" | abbr == "mild" | abbr == "mino" | abbr == "rash" | abbr == "skin"
    ~ "allergic reaction",
    abbr == "anap" ~ "anaphylaxsis",
    abbr == "beha" | abbr == "ment" | abbr == "pani" | abbr == "ams/" | abbr == "anxi" | abbr == "psyc" ~ "mental health",
    abbr == "burn" ~ "burn",
    abbr == "card" ~ "cardiovascular emergency",
    abbr == "ches" | abbr == "non" | abbr == "angi" ~ "chest pain",
    abbr == "dizz" ~ "dizziness",
    abbr == "envi" | abbr == "chem" | abbr == "bee " | abbr == "bug " | abbr == "heat" | abbr == "hot " | abbr == "cold" | abbr == "hydr" | abbr == "inse" | abbr == "wasp" | abbr == "tick" ~ "environmental injuries",
    abbr == "etoh" | abbr == "eval" ~ "alcohol and/or drugs",
    abbr == "eye " | abbr == "faci" | abbr == "blur" | abbr == "cott" | abbr == "ear " | abbr == "fore" | abbr == "irri" | abbr == "ocul" | abbr == "pain" ~ "eye/ear injuries",
    abbr == "fall" ~ "fall",
    abbr == "flu-" ~ "flu-like symptoms",
    abbr == "gast" | abbr == "naus" | abbr == "stom" | abbr == "emes" | abbr == "food"
    ~ "gastrointestinal",
    abbr == "head" | abbr == "migr" ~ "headache/head injury", 
    abbr == "hemo" | abbr == "lace" | abbr == "fing" ~ "laceration/hemorrhage",
    abbr == "hypo" | abbr == "diab" ~ "hypoglycemia",
    abbr == "moto" ~ "motor vehicle accident",
    abbr == "musc" | abbr == "arm " | abbr == "icep" | abbr == "leg " ~ "musculoskeletal injury",
    abbr == "over" | abbr == "took" ~ "non-alcoholic overdose",
    abbr == "resp" | abbr == "tons" | abbr == "asth" ~ "respiratory distress",
    abbr == "seiz" ~ "seizure",
    abbr == "soft" | abbr == "abra" | abbr == "spli" | abbr == "hema" | abbr == "scap" ~ "soft tissue injury",
    abbr == "stro" | abbr == "sync" ~ "stroke/syncope",
    TRUE ~ "other"
  )) %>%
  mutate(location = tolower(location)) %>%
  mutate(loc_abbr = substr(location,0,4)) %>%
  mutate(location = case_when(
    loc_abbr == "book" ~ "booknplow farm",
    loc_abbr == "chap" ~ "chapman/humphries/lincoln/rice",
    loc_abbr == "char" ~ "charles drew/cohan/lipton/garman/porter",
    loc_abbr == "conv" | loc_abbr == "noah" | loc_abbr == "morr" 
    ~ "noah webster circle",
    loc_abbr == "fres" | loc_abbr == "firs" ~ "first-year quad",
    loc_abbr == "gree" ~ "greenway dorms",
    loc_abbr == "gym/" ~ "gym/athletic fields",
    loc_abbr == "keef" ~ "keefe/beneski/mead",
    loc_abbr == "king" ~ "king/wieland",
    loc_abbr == "mars" ~ "marsh/plimpton/tyler",
    loc_abbr == "mayo" ~ "mayo-smith/seelye/hitchcock",
    loc_abbr == "merr" ~ "merrill/mcguire/seeley mudd",
    loc_abbr == "nepo" | loc_abbr == "newp" ~ "newport/seligman",
    loc_abbr == "powe" ~ "powerhouse",
    loc_abbr == "scie" ~ "science center",
    loc_abbr == "tapl" ~ "taplin/jenkins",
    loc_abbr == "vale" ~ "valentine quad"
  )) %>% 
  mutate(result = case_when(
    result == "Refusal" | result == "result" | result == "This didn't have to be a call" ~ "ACEMS care only",
    TRUE ~ "Higher level of care"
  )) %>% 
  mutate(
    ifEtOH = ifelse(complaint == "alcohol and/or drugs", 1, 0),
    time_of_call = substr(time_of_call,11,19),
    date_time = paste(date_of_call, time_of_call, sep = " ")) %>% 
  mutate(date_time = as.POSIXct(date_time)) %>% 
  filter(date_time > as.POSIXct("2000-07-01 01:00:00")) %>% 
  mutate(month = format(date_of_call, "%Y-%m")) %>%
  mutate(year = format(date_of_call, "%Y")) %>%
  mutate(
    day_of_week = weekdays(as.Date(date_of_call)),
    temp_date = as.POSIXct(paste0("2000-02-02", time_of_call)),
    time_of_day = case_when(
      temp_date >= as.POSIXct("2000-02-02 00:00:00") & temp_date < as.POSIXct("2000-02-02 04:00:00") ~ "Midnight - 4 AM",
      temp_date >= as.POSIXct("2000-02-02 04:00:00") & temp_date < as.POSIXct("2000-02-02 08:00:00") ~ "4 AM - 8 AM",
      temp_date >= as.POSIXct("2000-02-02 08:00:00") & temp_date < 
as.POSIXct("2000-02-02 12:00:00") ~ "8 AM - Noon",
      temp_date >= as.POSIXct("2000-02-02 12:00:00") & temp_date <
as.POSIXct("2000-02-02 16:00:00") ~ "Noon - 4 PM",
      temp_date >= as.POSIXct("2000-02-02 16:00:00") & temp_date <
as.POSIXct("2000-02-02 20:00:00") ~ "4 PM - 8 PM",
      temp_date >= as.POSIXct("2000-02-02 20:00:00") & temp_date <
as.POSIXct("2000-02-02 23:59:59") ~ "8 PM - Midnight"
    )
  ) %>% 
  mutate(
    semester = case_when(
      month == "2016-09" | month == "2016-10" | month == "2016-11" | month == "2016-12" ~ "Fall 2016",
      month == "2017-02" | month == "2017-03" | month == "2017-04" | month == "2017-05" ~ "Spring 2017",
      month == "2017-09" | month == "2017-10" | month == "2017-11" | month == "2017-12" ~ "Fall 2017",
      month == "2018-02" | month == "2018-03" | month == "2018-04" | month == "2018-05" ~ "Spring 2018",
      month == "2018-09" | month == "2018-10" | month == "2018-11" | month == "2018-12" ~ "Fall 2018",
      month == "2019-02" | month == "2019-03" | month == "2019-04" | month == "2019-05" ~ "Spring 2019",
       month == "2019-09" | month == "2019-10" | month == "2019-11" | month == "2019-12" ~ "Fall 2019",
      month == "2020-02" | month == "2020-03" | month == "2020-04" | month == "2020-05" ~ "Spring 2020",
      month == "2021-02" | month == "2021-03" | month == "2021-04" | month == "2021-05" ~ "Spring 2021",
      month == "2021-09" | month == "2021-10" | month == "2021-11" | month == "2021-12" ~ "Fall 2021",
      month == "2022-02" | month == "2022-03" | month == "2022-04" | month == "2022-05" ~ "Spring 2022",
      month == "2022-09" | month == "2022-10" | month == "2022-11" | month == "2022-12" ~ "Fall 2022",
      month == "2023-02" | month == "2023-03" | month == "2023-04" ~ "Spring 2023",
      TRUE ~ "test"
    )
  ) %>% 
  inner_join(raw_map_data, by = c("location" = "Name"))
```

#Save to RDS
```{r}
saveRDS(data, file = "wrangledData")
```

## Visual 1: Leaflet ##

# Data wrangling
```{r}
visual1data <- data %>%
  pivot_longer(location, names_to = "name", values_to = "location") %>% 
  group_by(location, geometry) %>%
  dplyr::summarize(
    N = n())

visual1more <- st_as_sf(visual1data) %>% 
  st_zm(drop = T, what = "ZM")

my_palette <- colorNumeric(palette = "YlGnBu",
                           domain = visual1more$N)
```

# Visual
```{r}
# https://gis.stackexchange.com/questions/253898/adding-a-linestring-by-st-read-in-shiny-leaflet
# visual1more$geometry
# 
# test <- st_zm(visual1more, drop = T, what = "ZM")


visual1 <- leaflet(data = visual1more) %>% 
  addTiles() %>% 
  addPolygons(
    fillColor = ~my_palette(N)[as.numeric(factor(N))],
    stroke = FALSE,
    fillOpacity = 0.5
  )

visual1
```

## Visual 2: Types of emergencies vs level of care needed ##

# Data wrangling
```{r initial wrangling}
visual2data <- data %>% 
  group_by(complaint) %>% 
  dplyr::summarize(
    N = n(),
    num_ACEMS = sum(result == "ACEMS care only"),
    num_higher = sum(result == "Higher level of care")
  ) %>% 
  mutate(
    per_ACEMS = round(((num_ACEMS) / N) * 100, digits = 2),
    per_higher = round(((num_higher) / N) * 100, digits = 2)
  ) %>% 
  pivot_longer(cols = c("per_ACEMS", "per_higher"), names_to = "type_of_care", values_to = "percentage")
```

# Visual
```{r}
ggplot(visual2data, aes(x = percentage, y = complaint, fill = type_of_care)) + 
  geom_bar(stat = "identity") +
  labs(
    title = "Type of care needed depending on type of emergency",
    x = "Type of emergency",
    y = "Percentage of emergencies"
  ) +
  # theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) + 
  scale_fill_manual(values = c("blue", "red"), name = "Type of care",
                    labels = c("ACEMS care only", "Higher level of care")) +
  scale_x_continuous(breaks = c(0, 25, 50, 75, 100), 
                     labels = c("0%", "25%", "50%", "75%", "100%"))
```

## Visual 3: number of calls over time ##

# Data wrangling
```{r}
visual3data <- data %>% 
  mutate(
    month_only = substr(month, 6,7)
  ) %>% 
  filter(month_only != "01" & month_only != "06" & month_only != "07" & month_only != "08") %>% 
  filter(month != "2016-03") %>%  # We only have data on this month in Spring 2016
  group_by(semester) %>% 
  dplyr::summarize(
    all_calls = n(),
    alcohol_calls = sum(ifEtOH == 1)
  ) %>% 
  pivot_longer(cols = c("all_calls", "alcohol_calls"), names_to = "call_type", values_to = "count")

visual3data$semester <- factor(visual3data$semester, levels = c("Fall 2016", "Spring 2017", "Fall 2017", "Spring 2018", "Fall 2018", "Spring 2019", "Fall 2019", "Spring 2020", "Spring 2021", "Fall 2021", "Spring 2022", "Fall 2022", "Spring 2023"))

visual3data <- visual3data %>% 
  arrange(semester)
```

# Visual
```{r}
ggplot(visual3data, aes(x = semester, y = count, group = call_type, color = call_type)) +
  geom_point(size = 2) + 
  geom_line() +
  labs(
    title = "Distribution of calls throughout the semester",
    x = "Semester",
    y = "Number of calls"
  ) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  scale_color_manual(values = c("blue", "black"), name = "Type of emergency",
                    labels = c("Alcohol calls only", "All calls")) +
  scale_y_continuous(breaks = c(0, 20, 40, 60, 80, 100, 120, 140, 160), 
                     labels = c("0", "20", "40", "60", "80", "100", "120", "140", "160"))
```


## Visual 4: calls at specific times of day and days of the week ##

# Data wrangling
```{r initial wrangling}
visual4combine <- data %>% 
  group_by(day_of_week, time_of_day) %>% 
  dplyr::summarize(
    N = n()
  )

visual4day <- data %>% 
  group_by(time_of_day) %>% 
  dplyr::summarize(
    N = n()
  )

visual4week <- data %>% 
  group_by(day_of_week) %>% 
  dplyr::summarize(
    N = n()
  )

visual4day$time_of_day <- factor(visual4day$time_of_day, levels = c("8 AM - Noon", "Noon - 4 PM", "4 PM - 8 PM", "8 PM - Midnight", "Midnight - 4 AM", "4 AM - 8 AM"))

visual4week$day_of_week <- factor(visual4week$day_of_week, levels = c("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"))
```
# Visual
```{r}
ggplot(data = visual4day, aes(x = time_of_day, y = N)) + 
  geom_bar(stat = 'identity', fill = "blue") +
  labs(
    title = "Number of calls throughout the day",
    x = "Time of day", 
    y = "Number of calls"
  ) +
  geom_text(aes(label = N), vjust = -0.2)

ggplot(data = visual4week, aes(x = day_of_week, y = N)) +
  geom_bar(stat = 'identity', fill = "blue") +
  labs(
    title = "Number of calls throughout the week",
    x = "Day of week",
    y = "Number of calls"
  ) +
  geom_text(aes(label = N), vjust = -0.2)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.